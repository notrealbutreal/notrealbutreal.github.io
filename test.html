<!DOCTYPE html>
<html>
    <head>
        <title>Logitech Serial Number Checker</title>
        <style>
            #container {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }

            .item {
                margin: 20px;
                padding: 20px;
                border: 1px solid black;
                display: flex;
                align-items: center;
            }

            .text {
                margin-right: 20px;
            }

            .image {
                width: 200px;
                height: auto;
            }

            #searchForm {
                display: flex;
                justify-content: center;
            }
        </style>
    </head>
    <body>
        <form method="POST" id="searchForm">
            <input type="text" id="serialNumber" name="serial_number" placeholder="Enter Serial Number">
            <input type="submit" value="Check">
        </form>
        <div id="container"></div>
    </body>
    <script>
        const pattern = new RegExp('src="([^"]+)"');

        async function getProductImageSource(productId) {
            const response = await fetch(`https://support.logi.com/api/v2/help_center/en-us/articles.json?label_names=webcontent=producttile,webproduct=${productId}`);
            const match = pattern.exec((await response.json()).articles[0].body);
            return match ? match[1] : null;
        }
        
        async function findProductBySerialNumber(serialNumber) {
            const response = await fetch(
                `https://apim.workato.com/product-lookup-v10/prod/serialization-ser-1?serial_number=${serialNumber}`,
                {
                    method: 'GET',
                    headers: {
                        "API-TOKEN": "eada23b666b5b1597cac6a0b2b62e219e30f09077fd75cb3ba8c361e74289a0f",
                        "Content-Type": "application/json",
                        "User-Agent": window.navigator.userAgent
                    }
                }
            );

            if (response.status === 200) {
                return (await response.json())["ProductList"];
            } else {
                return;
            }
        }


        function isLeapYear(year) {
            return year % 4 === 0 && (year % 100 !== 0 || year % 400 === 0);
        }


        function time_diff(time_left) {
            const periods = [
                ['Y', 60*60*24*365],
                ['D', 60*60*24],
                ['H', 60*60],
                ['M', 60],
                ['S', 1]
            ];

            let time_str = "";
            for (let i = 0; i < periods.length; i++) {
                let period_name = periods[i][0];
                let period_seconds = periods[i][1];
                if (time_left >= period_seconds || time_left <= -period_seconds) {
                    let period_value = Math.floor(time_left / period_seconds);
                    time_left %= period_seconds;
                    time_str += `${Math.abs(period_value)}${period_name}:`;
                }
            }

            return time_str.slice(0, -1) + (time_left < 0 ? " (Expired)" : " (Left)");
        }







        
        document.getElementById('searchForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            var serialNumber = document.getElementById('serialNumber').value;
            var product = await findProductBySerialNumber(serialNumber);

            if (!product) {
                return;
            }

            for (var i = 0; i < product.length; i++) { // for (let product of products) { ... }
                var container = document.getElementById('container');

                var attributes = product[i]["attributes"]

                // todo better and simple warranty time calculation, clean code

                let warranty_periods = new Set();

                for (let warranty of Object.values(attributes["warranty"])) {
                    for (let w of Object.values(warranty)) {
                        if ('year' in w) {
                            warranty_periods.add(w["year"].toString());
                        }
                    }
                }

                warranty_periods = Array.from(warranty_periods).sort();

                let _manufacture_date = new Date(product[i]["manufacture_date"]);
                let time_left_all = warranty_periods.map(warranty_period => (_manufacture_date.getTime() + 365*warranty_period*24*60*60*1000 - Date.now()) / 1000);
                let time_left_all_str = time_left_all.map(time_diff).join(" / ");



                var itemDiv = document.createElement('div');
                itemDiv.className = 'item';
    
                var textDiv = document.createElement('div');
                textDiv.className = 'text';

                var text = `\
Serial Number (S/N):         ${serialNumber}
Part Number (P/N):           ${product[i]["part_number"]}
Model Number (M/N):          ${attributes["model_numbers"]}
Name:                        ${attributes["name"]}
Second Name:                 ${attributes["name_2"]}
Short Name:                  ${attributes["short_name"]}
Description:                 ${attributes["description"]}
Status:                      ${attributes["status"]}
Manufacture Date:            ${product[i]["manufacture_date"]}
Is Ticketable?               ${attributes["is_ticketable"]}
Is Registerable?             ${attributes["is_registerable"]}
Product Recovery?            ${attributes["elabel_product_recovery"]}
Return/Destruction Required? ${attributes["elabel_return_destruction_required"]}
Warranty Duration:           ${warranty_periods.join('/')} Year(s)
Remaining Warranty Time:     ${time_left_all_str}`;

                textDiv.innerHTML = `<pre>${text}</pre>`;
                itemDiv.appendChild(textDiv);

                var image = await getProductImageSource(product[i]["id"]);

                if (image) {
                    var imgElement = document.createElement('img');
                    imgElement.src = image;
                    imgElement.className = 'image';
                    itemDiv.appendChild(imgElement);
                }

                container.appendChild(itemDiv);
            }
        });
    </script>
</html>